#!/usr/bin/env python3
"""
DSLighting Titanic æ¯”èµ›è¿è¡Œç¤ºä¾‹

å±•ç¤ºå¦‚ä½•ä½¿ç”¨ DSLighting æ¥è§£å†³ Kaggle Titanic æ¯”èµ›
"""

import sys
import os
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

import dslighting

def main():
    print("="*80)
    print("DSLighting - Titanic æ¯”èµ›ç¤ºä¾‹")
    print("="*80)
    print()

    # ==================== æ–¹å¼ 1: ä½¿ç”¨ task_idï¼ˆæ¨èï¼‰ ====================
    print("æ–¹å¼ 1: ä½¿ç”¨ task_idï¼ˆéœ€è¦å…ˆé…ç½® registryï¼‰")
    print("-" * 80)

    # å¦‚æœå·²ç»åœ¨ dslighting/registry/titanic/ é…ç½®å¥½äº†
    # å¯ä»¥ç›´æ¥ä½¿ç”¨ task_id
    try:
        print("\næ­£åœ¨åŠ è½½æ•°æ®...")
        data = dslighting.load_data("titanic")
        print(f"âœ… æ•°æ®åŠ è½½æˆåŠŸ: {data}")
        print()

        # æ˜¾ç¤ºæ•°æ®ä¿¡æ¯
        print(data.show())
        print()

        # è¿è¡Œ Agent
        print("æ­£åœ¨è¿è¡Œ Agent...")
        agent = dslighting.Agent()

        result = agent.run(
            data,
            model="openai/gpt-4",  # æˆ– "gpt-3.5-turbo" ä»¥èŠ‚çœæˆæœ¬
            workflow="aide",  # å¯é€‰: aide, autokaggle, data_interpreter
            max_iterations=5,  # é™åˆ¶è¿­ä»£æ¬¡æ•°
        )

        # æ˜¾ç¤ºç»“æœ
        print("\n" + "="*80)
        print("ğŸ¯ è¿è¡Œç»“æœ")
        print("="*80)
        print(f"åˆ†æ•°: {result.score}")
        print(f"æäº¤æ–‡ä»¶: {result.output_path}")
        print(f"è¿è¡Œæ—¶é—´: {result.metadata.get('duration', 'N/A')}")
        print()

    except Exception as e:
        print(f"âŒ æ–¹å¼ 1 å¤±è´¥: {e}")
        print("æç¤º: è¯·ç¡®ä¿å·²åœ¨ dslighting/registry/titanic/ åˆ›å»ºé…ç½®æ–‡ä»¶")
        print()

    # ==================== æ–¹å¼ 2: ç›´æ¥æŒ‡å®šæ•°æ®è·¯å¾„ ====================
    print("\n" + "="*80)
    print("æ–¹å¼ 2: ç›´æ¥æŒ‡å®šæ•°æ®è·¯å¾„")
    print("-" * 80)

    try:
        # æŒ‡å®šæ•°æ®ç›®å½•
        data_dir = project_root / "data/competitions/titanic"

        if not data_dir.exists():
            print(f"âŒ æ•°æ®ç›®å½•ä¸å­˜åœ¨: {data_dir}")
            print("\nè¯·å…ˆè¿è¡Œ: python prepare_data.py")
            return

        print(f"\næ­£åœ¨åŠ è½½æ•°æ®: {data_dir}")
        data = dslighting.load_data(data_dir)

        # æ˜¾ç¤ºæ•°æ®ä¿¡æ¯
        print("\næ•°æ®ä¿¡æ¯:")
        print(f"  Task ID: {data.task_id}")
        print(f"  Task Type: {data.get_task_type()}")
        print(f"  Data Dir: {data.data_dir}")
        print()

        # åˆ›å»º Agent å¹¶è¿è¡Œ
        print("æ­£åœ¨è¿è¡Œ Agent...")
        agent = dslighting.Agent()

        result = agent.run(
            data,
            model="openai/gpt-4",
            workflow="aide",
            max_iterations=3,  # ç¤ºä¾‹ä½¿ç”¨è¾ƒå°‘è¿­ä»£
        )

        # æ˜¾ç¤ºç»“æœ
        print("\n" + "="*80)
        print("ğŸ¯ è¿è¡Œç»“æœ")
        print("="*80)
        print(f"åˆ†æ•°: {result.score}")
        print(f"æäº¤æ–‡ä»¶: {result.output_path}")
        print()

        # æ˜¾ç¤ºæäº¤æ–‡ä»¶å†…å®¹
        if result.output_path and Path(result.output_path).exists():
            import pandas as pd
            submission = pd.read_csv(result.output_path)
            print("æäº¤æ–‡ä»¶é¢„è§ˆ:")
            print(submission.head(10))
            print()

    except Exception as e:
        print(f"âŒ æ–¹å¼ 2 å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()

    # ==================== æäº¤åˆ° Kaggle ====================
    print("\n" + "="*80)
    print("ğŸ“¤ æäº¤åˆ° Kaggle")
    print("="*80)
    print("\næäº¤å‘½ä»¤:")
    print("kaggle competitions submit -c titanic \\")
    print("  -f <submission_file> \\")
    print("  -m 'Generated by DSLighting'")
    print()

if __name__ == "__main__":
    main()
